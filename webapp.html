<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Cataract Detector</title>

  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-white text-gray-800">

  <div class="max-w-lg mx-auto p-6">
    <h1 class="text-3xl font-bold text-green-600 mb-4 text-center">
      Cataract Detector (Beta)
    </h1>

    <!-- Upload area -->
    <div id="upload-area"
         class="border-2 border-dashed border-green-400 rounded-lg p-6 text-center cursor-pointer hover:bg-green-50">
      <p class="mb-2">Click or drop an image here</p>
      <p class="text-sm text-gray-500">Make sure it's a clear photo of your eye.</p>
      <input id="file-input" type="file" accept="image/*" class="hidden" />
    </div>

    <!-- Preview -->
    <div id="preview-container" class="mt-6 hidden">
      <img id="preview" alt="Preview" class="mx-auto rounded-lg border"/>
    </div>

    <!-- Analyze button -->
    <button id="analyze-btn"
            class="mt-6 w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 disabled:opacity-50"
            disabled>
      Analyze
    </button>

    <!-- Result card -->
    <div id="result-card" class="mt-6 hidden p-4 rounded-lg border">
      <h2 id="result-label" class="text-2xl font-semibold"></h2>
      <p id="result-confidence" class="mt-2"></p>
      <a id="doctor-link" href="#" target="_blank"
         class="mt-4 inline-block bg-red-500 text-white px-4 py-2 rounded-lg hidden">
        Consult a Doctor
      </a>
    </div>

    <!-- Error message -->
    <p id="error-msg" class="mt-4 text-red-600 text-center"></p>

    <!-- Disclaimer -->
    <p class="mt-8 text-center text-sm text-gray-500">
      ⚠️ Beta app: ~90% accuracy. Results are indicative only.
    </p>
  </div>

  <script>
    // **CONFIG** – change these!
    const API_URL = 'https://your-flask-api.com/predict'
    const API_KEY = 'YOUR_API_KEY'

    const uploadArea = document.getElementById('upload-area')
    const fileInput = document.getElementById('file-input')
    const previewContainer = document.getElementById('preview-container')
    const preview = document.getElementById('preview')
    const analyzeBtn = document.getElementById('analyze-btn')
    const resultCard = document.getElementById('result-card')
    const resultLabel = document.getElementById('result-label')
    const resultConfidence = document.getElementById('result-confidence')
    const doctorLink = document.getElementById('doctor-link')
    const errorMsg = document.getElementById('error-msg')

    let selectedFile = null

    // Open file picker on click
    uploadArea.addEventListener('click', () => fileInput.click())

    // Handle dropped files
    uploadArea.addEventListener('dragover', e => {
      e.preventDefault()
      uploadArea.classList.add('bg-green-50')
    })
    uploadArea.addEventListener('dragleave', e => {
      uploadArea.classList.remove('bg-green-50')
    })
    uploadArea.addEventListener('drop', e => {
      e.preventDefault()
      uploadArea.classList.remove('bg-green-50')
      if (e.dataTransfer.files.length) {
        handleFile(e.dataTransfer.files[0])
      }
    })

    // Handle file input
    fileInput.addEventListener('change', () => {
      if (fileInput.files.length) {
        handleFile(fileInput.files[0])
      }
    })

    function handleFile(file) {
      if (!file.type.startsWith('image/')) {
        showError('Please upload a valid image file.')
        return
      }
      selectedFile = file
      const url = URL.createObjectURL(file)
      preview.src = url
      previewContainer.classList.remove('hidden')
      analyzeBtn.disabled = false
      clearResult()
    }

    function clearResult() {
      resultCard.classList.add('hidden')
      errorMsg.textContent = ''
      doctorLink.classList.add('hidden')
    }

    // Analyze button click
    analyzeBtn.addEventListener('click', async () => {
      if (!navigator.onLine) {
        return showError('No internet connection. Please connect and retry.')
      }
      if (!selectedFile) return
      analyzeBtn.disabled = true
      errorMsg.textContent = ''
      resultCard.classList.add('hidden')
      resultLabel.textContent = 'Analyzing…'

      const form = new FormData()
      form.append('image', selectedFile, selectedFile.name)

      try {
        const resp = await fetch(API_URL, {
          method: 'POST',
          headers: { 'X-API-Key': API_KEY },
          body: form
        })
        if (!resp.ok) throw new Error(`Server error: ${resp.status}`)
        const { label, confidence } = await resp.json()

        // Display result
        let bg, textColor = 'text-gray-800'
        if (label === 'Cataract') { bg = 'bg-yellow-100'; textColor = 'text-yellow-800' }
        else if (label === 'Healthy') bg = 'bg-green-100'
        else bg = 'bg-gray-100'

        resultCard.className = `mt-6 p-4 rounded-lg border ${bg}`
        resultLabel.textContent = `Result: ${label}`
        resultLabel.className = `text-2xl font-semibold ${textColor}`
        resultConfidence.textContent = `Confidence: ${(confidence*100).toFixed(1)}%`

        // If high severity, show doctor link
        if (label === 'Cataract' && confidence > 0.9) {
          doctorLink.href = 'mailto:your.eye.doctor@example.com'
          doctorLink.classList.remove('hidden')
        }
        resultCard.classList.remove('hidden')
      } catch (e) {
        showError(e.message)
      } finally {
        analyzeBtn.disabled = false
      }
    })

    function showError(msg) {
      errorMsg.textContent = msg
    }
  </script>
</body>
</html>
